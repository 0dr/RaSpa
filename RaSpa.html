
<div class="main-body">
  <input name="attr_defaultTab" id="Übersicht" type="radio"/>
  <label for="Übersicht">Übersicht</label>
  <div class="tab">
    <div class="component"></div>
    <p>loedjöfhdölsfg ghöf öshfjgöfs jghfjsg ljdfghl dfalgdf ghadfjghadfl gkdhaflgh dflaghdlafg had#</p>
    <p>dfjhgkljdfsg ödfgödf hjgdfag öjdfagödfag öfagö göfdhgöjadf gg p dföghdsg </p>
    <p>435897ß3457ß078ß0457ß8 pughpsh gdfsh</p>
  </div>
  <input name="attr_defaultTab" id="Attribute" type="radio"/>
  <label for="Attribute">Attribute</label>
  <div class="tab">
    <div class="values">
      <label title="enter AuD">AuD
        <input name="attr_AuD" title="@{AuD}" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      </label>
      <button class="text-capitalize" name="roll_AuD" type="roll" value="&{template:default} {{header=AuD}} {{Qualität = [[@{AuD}]] [[1d8<@{AuD}f8-1]]}}"></button>
      <label title="enter GeH">GeH
        <input name="attr_GeH" title="@{GeH}" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      </label>
      <button class="text-capitalize" name="roll_GeH" type="roll" value="&{template:default} {{header=GeH}} {{Qualität = [[@{GeH}]] [[1d8<@{GeH}f8-1]]}}"></button>
      <label title="enter MuK">MuK
        <input name="attr_MuK" title="@{MuK}" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      </label>
      <button class="text-capitalize" name="roll_MuK" type="roll" value="&{template:default} {{header=MuK}} {{Qualität = [[@{MuK}]] [[1d8<@{MuK}f8-1]]}}"></button>
      <label title="enter RaT">RaT
        <input name="attr_RaT" title="@{RaT}" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      </label>
      <button class="text-capitalize" name="roll_RaT" type="roll" value="&{template:default} {{header=RaT}} {{Qualität = [[@{RaT}]] [[1d8<@{RaT}f8-1]]}}"></button>
      <label title="enter KrT">KrT
        <input name="attr_KrT" title="@{KrT}" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      </label>
      <button class="text-capitalize" name="roll_KrT" type="roll" value="&{template:default} {{header=KrT}} {{Qualität = [[@{KrT}]] [[1d8<@{KrT}f8-1]]}}"></button>
      <label title="enter WiK">WiK
        <input name="attr_WiK" title="@{WiK}" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      </label>
      <button class="text-capitalize" name="roll_WiK" type="roll" value="&{template:default} {{header=WiK}} {{Qualität = [[@{WiK}]] [[1d8<@{WiK}f8-1]]}}"></button>
    </div>
    <div class="rolls"> 
      <label for="roll_AuD">AuD</label>
      <input name="attr_roll_AuD" id="roll_AuD" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      <label for="roll_GeH">GeH</label>
      <input name="attr_roll_GeH" id="roll_GeH" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      <label for="roll_MuK">MuK</label>
      <input name="attr_roll_MuK" id="roll_MuK" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      <label for="roll_RaT">RaT</label>
      <input name="attr_roll_RaT" id="roll_RaT" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      <label for="roll_KrT">KrT</label>
      <input name="attr_roll_KrT" id="roll_KrT" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      <label for="roll_WiK">WiK</label>
      <input name="attr_roll_WiK" id="roll_WiK" type="number" value="0" min="0" max="99" step="1" pattern="^[0-9]"/>
      <button class="text-capitalize" name="act_probe" type="action"></button>
    </div>
  </div>
  <input name="attr_defaultTab" id="Eigenschaften" type="radio"/>
  <label for="Eigenschaften">Eigenschaften</label>
  <div class="tab">
    <p>test 2</p>
    <p>93405ß91345j25g7h24gß7gohljghdflskgög gfgkjg ögöja ghöjadfg hjafg öjdfagödfag</p>
    <p>34905b3ßk nmmhuif89ßn78ß45  ßjbg2458ßj62j6</p>
  </div>
  <input name="attr_defaultTab" id="Fertigkeiten" type="radio"/>
  <label for="Fertigkeiten">Fertigkeiten</label>
  <div class="tab">
    <p>test 2</p>
    <p>93405ß91345j25g7h24gß7gohljghdflskgög gfgkjg ögöja ghöjadfg hjafg öjdfagödfag</p>
    <p>34905b3ßk nmmhuif89ßn78ß45  ßjbg2458ßj62j6</p>
  </div>
  <input name="attr_defaultTab" id="Ressourcen" type="radio"/>
  <label for="Ressourcen">Ressourcen</label>
  <div class="tab">
    <p>test 2</p>
    <p>93405ß91345j25g7h24gß7gohljghdflskgög gfgkjg ögöja ghöjadfg hjafg öjdfagödfag</p>
    <p>34905b3ßk nmmhuif89ßn78ß45  ßjbg2458ßj62j6</p>
  </div>
</div>
<rolltemplate class="sheet-rolltemplate-rolls">
  <div class="sheet-template-container">
    <!-- - Display a header on the template --->
    <div class="sheet-template-header">{{#header}} <b>{{header}}</b>{{/header}}</div>
    <!-- - Display the dice roll in the template --->
    <div class="sheet-template-body">{{#dice}}
      <div class="sheet-template-row">{{dice}}</div>{{/dice}}
      <!-- - Display a description. This is great for text included with a roll --->{{#desc}}
      <div class="sheet-template-row"><span class="sheet-template-desc">{{desc}}</span></div>{{/desc}}
    </div>
  </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-test"> 
  <div class="sheet-template-container">
    <h1>{{name}}</h1>
    <div class="sheet-results">
      <h4>Result = {{roll1}}</h4>
      <h4>Custom Result = {{computed::roll1}}</h4>
    </div>
  </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-attributes">
  <div class="sheet-template-container">
    <div class="sheet-template-header">{{#header}} <b>{{header}}</b>{{/header}}</div>
    <div class="sheet-template-body">{{#aud}}
      <div class="sheet-template-row">{{aud}}</div>{{/aud}}
      {{#geh}}
      <div class="sheet-template-row">{{geh}}</div>{{/geh}}
      {{#muk}}
      <div class="sheet-template-row">{{muk}}</div>{{/muk}}
      {{#rat}}
      <div class="sheet-template-row">{{rat}}</div>{{/rat}}
      {{#krt}}
      <div class="sheet-template-row">{{krt}}</div>{{/krt}}
      {{#wik}}
      <div class="sheet-template-row">{{wik}}</div>{{/wik}}
      {{#qual}}
      <div class="sheet-template-row"><span class="sheet-template-desc">{{qual}}</span></div>{{/qual}}
    </div>
  </div>
</rolltemplate>
<script type="text/worker">
  /*
    Autor:      Onyxring
    GIT:        https://github.com/onyxring/Roll20Async

*/ 


function setActiveCharacterId(charId){
    var oldAcid=getActiveCharacterId();
    var ev = new CustomEvent("message");
    ev.data={"id":"0", "type":"setActiveCharacter", "data":charId};
    self.dispatchEvent(ev); 
    return oldAcid;
}
var _sIn=setInterval;
setInterval=function(callback, timeout){
    var acid=getActiveCharacterId();
    _sIn(
        function(){
            var prevAcid=setActiveCharacterId(acid);
            callback();
            setActiveCharacterId(prevAcid);
        }
    ,timeout);
}
var _sto=setTimeout
setTimeout=function(callback, timeout){
    var acid=getActiveCharacterId();
    _sto(
        function(){
            var prevAcid=setActiveCharacterId(acid);
            callback();
            setActiveCharacterId(prevAcid);
        }
    ,timeout);
}
function getAttrsAsync(props){
    var acid=getActiveCharacterId(); //save the current activeCharacterID in case it has changed when the promise runs 
    var prevAcid=null;               //local variable defined here, because it needs to be shared across the promise callbacks defined below
    return new Promise((resolve,reject)=>{
            prevAcid=setActiveCharacterId(acid);  //in case the activeCharacterId has changed, restore it to what we were expecting and save the current value to restore later
            try{
                getAttrs(props,(values)=>{  resolve(values); }); 
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); //restore activeCharcterId to what it was when the promise first ran
    });
}
//use the same pattern for each of the following...
function setAttrsAsync(propObj, options){
    var acid=getActiveCharacterId(); 
    var prevAcid=null;               
    return new Promise((resolve,reject)=>{
            prevAcid=setActiveCharacterId(acid);  
            try{
                setAttrs(propObj,options,(values)=>{ resolve(values); });
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); 
    });
}

function getSectionIDsAsync(sectionName){
    var acid=getActiveCharacterId(); 
    var prevAcid=null;               
    return new Promise((resolve,reject)=>{
            prevAcid=setActiveCharacterId(acid);  
            try{
                getSectionIDs(sectionName,(values)=>{ resolve(values); });
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); 
    });
}
function getSingleAttrAsync(prop){ 
    var acid=getActiveCharacterId(); 
    var prevAcid=null;               
    return new Promise((resolve,reject)=>{
            prevAcid=setActiveCharacterId(acid);  
            try{
                getAttrs([prop],(values)=>{  resolve(values[prop]); }); 
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); 
    });
}
  on('', (info) => {
  startRoll("&{template:test} {{name=Test}} {{roll1=[[1d8]]}}", (results) => {
    const total = results.results.roll1.result
    const computed = total % 4;

    finishRoll(
      results.rollId,
      {
        roll1: computed
      }
    );
  });
});


on('clicked:probe', (info) => {
    groupRoll(["AuD", "GeH", "MuK", "RaT", "KrT", "WiK"]);
});
async function groupRoll(group_) {
    const rollHeader = "&{template:default} ";
    var rollString = "";
    //var attributes = await getAttrsAsync(group_);
    var attributeRollcounts =  await getAttrsAsync(group_.map((line) => `roll_${line}`));
    for (index in group_) {
        var attrName = group_[index];
        var attrCountName = Object.keys(attributeRollcounts)[index];
        var attrCount =attributeRollcounts[attrCountName];
        if (attrCount > 0) {
            rollString += ` {{${attrName}=[[@{${attrCountName}}d8<@{${attrName}}f8-@{${attrCountName}}]]}}`;
        } 
    }
    startRoll(rollHeader + rollString, (results) => {finishRoll(results.rollId)});
}

// [[10d8<4f8 -10]]
// `A ${wutt}, lol`
</script>